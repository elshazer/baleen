#!/usr/bin/env ruby

require "thor"
require "baleen"

module BaleenCliHelper
  def job_start(config)
    klass = config[:framework][:type].to_s.capitalize
    task = Baleen::Task.const_get(klass).new(
      image: config[:runner][:image],
      work_dir: config[:runner][:work_dir],
      files: config[:framework][:files],
      before_command: config[:runner][:before_command],
      concurrency: config[:runner][:concurrency].to_i,
    )
    client  = Baleen::Client.new(config[:base][:baleen_server], config[:base][:port])
    job     = Baleen::Job.new(client, task)
    job.start
  end
end

module BaleenCLI
  class Project < Thor

    include Baleen::Default

    option :baleen_server
    option :port

    desc "start", "Running baleen project"
    def start(name)
      baleen_server = ENV["baleen_server"] || options[:baleen_server] || default_baleen_server
      port = ENV["baleen_port"] || options[:port] || default_port
      task = Baleen::Task::Project.new(
        :project => name
      )
      client  = Baleen::Client.new(baleen_server, port)
      job     = Baleen::Job.new(client, task)
      job.start
    end
    default_task :start

    desc "list", "List baleen projects registered at baleen-server"
    def list
      #TODO
    end
  end

  class Cucumber < Thor

    include Baleen::Default
    include BaleenCliHelper

    option :baleen_server, :required => true
    option :port
    option :before_command
    option :concurrency
    option :work_dir
    option :features
    option :image, :required => true

    desc "cucumber", "Running cucumber project from options"
    def cucumber
     cfg = {
       base: {
         baleen_server: options[:baleen_server],
         port: options[:port]                    || default_port
       },
       runner: {
         before_command: options[:before_command] || default_before_command,
         concurrency: options[:concurrency]       || default_concurrency,
         work_dir: options[:work_dir]             || default_work_dir,
         image: options[:image],
       },
       framework: {
         files: options[:features] || default_features,
         type: "cucumber"
       }
     }

     job_start(cfg)
    end
  end

  class Main < Thor

    desc "project", "Project"
    subcommand "project", Project

    desc "cucumber", "Running cucumber project from options"
    subcommand "cucumber", Cucumber
  end
end

BaleenCLI::Main.start
